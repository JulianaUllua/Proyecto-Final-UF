#:kivy 1.1.0
#: import Button kivy.uix.button.Button
#:import F kivy.factory.Factory

<MainFloatLayout>:
        id: mainfloat
        BoxLayout:
                orientation:"vertical"
                size_hint: 1, 1
                AppMenu:
                        id: top_menu
                        top: root.height
                        cancel_handler_widget: mainfloat

                        AppMenuTextItem:
                                text: 'Save Image' #todavia no funciona
                                #on_release: root.show_save()
                                ContextMenu:
                        AppMenuTextItem:
                                text: 'Extract Code' 
                                on_press: root.show_extraer_popup()
                                on_release: root.Extract_Pipe_Code()
                                ContextMenu:
                        AppMenuTextItem:
                                text: 'Clear Screen'
                                on_release: root.clear_screen()
                                ContextMenu:
                        AppMenuTextItem:
                                text: 'Image Viewer'
                                on_release: root.image_viewer()
                                ContextMenu:
                        AppMenuTextItem:
                                text: 'Run Pipe'
                                on_release: root.find_pipes()  
                                ContextMenu: 
                        AppMenuTextItem:
                                text: 'Save Workspace'
                                on_press: root.show_extraer_popup("save")
                                #on_release: root.to_file("saved_file")
                                ContextMenu:  
                AppMenu:
                        id: tool_bar
                        top: root.height - top_menu.size[1]
                        cancel_handler_widget: mainfloat

                        FilterDDTrigger:
                                size_hint: 0.2, 1
                                text: 'Tool Bar'
                                dropdown:
                                        F.FilterDD(dismiss_on_select = False)
                          
                FloatLayout:
                        id: bloques_box
                        size_hint: 1, 0.88
                        canvas:
                                Color:
                                        rgba: 255, 255, 255, 255


<MyScatterLayout>:
        
        BoxLayout:
                id: scatter_box
                canvas.before:
                
                        Color:
                                rgba: 1, 1, 1, 1
                        Line:
                                width: 0.000000001 if root.isShownMenu else 1
                                rounded_rectangle: 28, 118, 96, 30, 8, 20
                BoxLayout:
                        orientation: "vertical"
                        id: inputs 
                        #opacity: 1 if root.isShownMenu else 0
                        size_hint: .2, 0   
                        pos_hint: {'x': 0, 'y': 0.35} if root.isShownMenu else {'x': 0, 'y': 0.75}                   
                BoxLayout:
                        orientation: "vertical"
                        size_hint: .8, 1
                        BoxLayout:
                                orientation:"horizontal"
                                size_hint: 1,.2
                                MyButton: #para que no funcione touch down
                                        
                                        id: funcion_scatter
                                        background_color: 0,0,0,0
                                        halign: 'center'
                                        valign: 'center'
                                        text_size: self.size 
                                        font_size: '12'
                                        size_hint: .4,1
                                        
                                Button:
                                        id: button_size
                                        background_color: 0,0,0,0
                                        size_hint: .15,1
                                        
                                        #on_release: context_menu.show()
                                        #on_release: context_menu.show(*app.root_window.mouse_pos)
                                        #on_press: root.change_size()
                                        on_press: root.isShownMenu = not root.isShownMenu
                                        on_release: minimize.source = "icons/minimize.png" if root.isShownMenu else "icons/maximize.png"
                                        on_touch_move: root.update_line(root)
                                        on_touch_up: root.update_line(root)
                                        on_touch_down: root.update_line(root) 
                                        Image:
                                                id: minimize
                                                source: "icons/minimize.png"
                                                center_x: self.parent.center_x
                                                center_y: self.parent.center_y
                                                size: 20,20
                                Button:
                                        size_hint: .15,1
                                        background_color: 0,0,0,0
                                        on_press: root.delete_scatter(root)
                                        on_touch_move: root.update_line(root)
                                        on_touch_up: root.update_line(root)
                                        on_touch_down: root.update_line(root)
                                        Image:
                                                id: cancel
                                                source: "icons/cancel.png"
                                                center_x: self.parent.center_x
                                                center_y: self.parent.center_y
                                                size: 20,20
                                         
                        MyButton:
                                id: mybutton
                                background_color: 0,0,0,0
                                opacity: 1 if root.isShownMenu else 0
                                canvas.before:
                                        Color:
                                                rgba: 1, 1, 1, 1
                                        Line:
                                                width: 1
                                                rounded_rectangle: self.x, self.y, self.width, self.height, 8, 20
                                size_hint: 1,.8 
                                on_touch_move: root.update_line(root)
                                on_touch_up: root.update_line(root)
                                on_touch_down: root.update_line(root)
                                Image:
                                        id: image_scatter
                                        size: mybutton.size 
                                        pos: mybutton.pos
                                        source: ""
                                        color: 0,0,0,0               
                BoxLayout:
                        orientation: "vertical"
                        #opacity: 1 if root.isShownMenu else 0
                        id: outputs    
                        size_hint: .2, 0  
                        pos_hint: {'x': 0.75, 'y': 0.35} if root.isShownMenu else {'x': 0.75, 'y': 0.75}   
        BoxLayout:
                orientation: "vertical"
                ContextMenu:
                        id: context_menu
                        visible: False
                        cancel_handler_widget: scatter_box
                        pos_hint: {'x': 0.5, 'y': 0.5}
                        
                        ContextMenuTextItem:
                                text: "Duplicate"
                                on_release: root.duplicate()
                                                    
                        #ContextMenuTextItem:
                        #        text: "Edit outputs"
                        #        on_release: root.add_outputs(root)


<SavedFloatScreen>:
        on_enter: root.fileload()
        MainFloatLayout:


<MenuScreen>:
        canvas.before:
                Rectangle:
                        pos: self.pos
                        size: self.size
                        source:"icons\\background.jpg"
        BoxLayout:
                
                size_hint: None, None
                size: 350, 100
                center: root.center
                orientation: 'vertical'
                Label:
                        text: "ProtoPype"
                        font_name: "Roboto"
                        bold: True
                        font_size:'20sp'
                        Image:
                                source:"icons\\pipe.png"
                                center_x: self.parent.center_x + 60
                                center_y: self.parent.center_y
                                size: 25,25
                Label:
                        size_hint: 0.1,0.3 
                Button:
                        text: 'New'
                        font_name: "Roboto"
                        on_press: root.manager.current = 'main screen'
                        
                        background_color: 0,0,0,0
                        canvas.before:
                                Color:
                                        rgba: 1, 1, 1, 1
                                Line:
                                        width: 1
                                        rounded_rectangle: self.x, self.y, self.width, self.height, 8, 100
                        Image:
                                source:"icons\\new.png"
                                center_x: self.parent.center_x - 34
                                center_y: self.parent.center_y
                                size: 25,25
                Label:
                        size_hint: 0.1,0.3  
                Button:
                        text: 'Open'
                        font_name: "Roboto"
                        on_press: root.manager.current = 'saved screen'
                        

                        background_color: 0,0,0,0
                        canvas.before:
                                Color:
                                        rgba: 1, 1, 1, 1
                                Line:
                                        width: 1
                                        rounded_rectangle: self.x, self.y, self.width, self.height, 8, 100
                        Image:
                                source:"icons\\open.png"
                                center_x: self.parent.center_x - 34
                                center_y: self.parent.center_y
                                size: 23,23


<Parameters_Popup>:
        BoxLayout:
                orientation:"vertical"
                pos_hint: {"x": 0, "top": 1}
                BoxLayout:
                        orientation:"horizontal"
                        size_hint: 1, .9
                        id:boxlay
        
                        TabbedPanel:
                                size_hint: .5, 1
                                do_default_tab: False
                                TabbedPanelItem:
                                        text: 'Parameters'
                                        BoxLayout:
                                                orientation: "vertical"
                                                id: variable_box
                                TabbedPanelItem:
                                        text: 'Opcional'
                                        BoxLayout:
                                                orientation: "vertical"
                                                BoxLayout:
                                                        orientation: "vertical"
                                                        id: opcional_checkbox_input
                                                        size_hint: 1, .3
                                                        Label:
                                                                text: "Input:"
                                                                height: 20

                                                BoxLayout:
                                                        orientation: "vertical"
                                                        id: opcional_checkbox_output
                                                        size_hint: 1, .3
                                                        Label:
                                                                text: "Output:"
                                                                height: 20

                        BoxLayout:
                                orientation: "vertical"
                                size_hint: .5, 1
                                spacing: 15 
                                Image:
                                        id: image_popup
                                        size_hint: 1, .9
                                        source: ""
                                        color: 0,0,0,0
                                                
                BoxLayout:
                        orientation: "horizontal"
                        size_hint: 1, .1
                        Button:
                                id: btn_restore_parametros
                                size_hint: 0.9, 0.9
                                text: "Default"
                                halign: 'center'
                                valign: 'center'
                                text_size: self.width - dp(10), self.height - dp(10)
                                on_press: root.restore_parameters() 
                        Button:
                                id: btn_try_parametros
                                size_hint: 0.9, 0.9
                                text: "Try"
                                halign: 'center'
                                valign: 'center'
                                text_size: self.width - dp(10), self.height - dp(10)
                                on_press: root.try_parameters()
                        
                        Button:
                                id: btn_duplicate
                                size_hint: 0.9, 0.9
                                text: "Duplicate"
                                halign: 'center'
                                valign: 'center'
                                text_size: self.width - dp(10), self.height - dp(10)
                                on_press: root.duplicate()
                        Button:
                                id: btn_guardar_parametros
                                size_hint: 0.9, 0.9
                                text: "Save"
                                halign: 'center'
                                valign: 'center'
                                on_press: root.save_parameters() 
                        Button:
                                id: btn_cancelar_parametros
                                size_hint: 0.9, 0.9
                                text: "Cancel"
                                halign: 'center'
                                valign: 'center'
                                on_press: root.cancel_parameters() 

<MyToggleButton>:
        id: MyToggleButton
        orientation: "horizontal"
        spacing: 15
        Label:
                text_size: self.size
                text: root.label + ":"
                halign: 'center'
                valign: 'center' 
                size_hint: 1,0.1
        ToggleButton:
                id: text_1 
                text: root.text_1
                on_press: self.state = "down"
                on_release: root.state_change(self.id)
                

        ToggleButton:
                id: text_2
                text: root.text_2
                group: 'bool'
                state: 'down'
                on_press: self.state = "down"
                on_release: root.state_change(self.id)


<MySize>:
        id: MySize
        orientation: "horizontal"
        spacing: 15
        Label:
                text_size: self.size
                text: root.text_label + ":"
                halign: 'center'
                valign: 'center' 
                size_hint: 0.4,0.1
        Label:
                text_size: self.size
                text: "("
                font_size: '20sp'
                halign: 'center'
                valign: 'center' 
                size_hint: 0.1,0.1
                bold: True 
        TextInput:
                id: text_input_1
                input_filter: root.input_type_1
                size_hint: 0.15,0.01
                text: str(root.value_1)
                multiline:False
        Label:
                text_size: self.size
                text: ","
                font_size: '20sp'
                halign: 'center'
                valign: 'center' 
                size_hint: 0.1,0.1
                bold: True 
        TextInput:
                id: text_input_2
                input_filter: root.input_type_2
                size_hint: 0.15,0.1
                text: str(root.value_2) 
                multiline:False
        Label:
                text_size: self.size
                text: ")"
                font_size: '20sp'
                halign: 'center'
                valign: 'center' 
                size_hint: 0.1,0.1
                bold: True 

<MyTextInput>:
        id: MyTextInput
        orientation: "horizontal"
        spacing: 15
        Label:
                text_size: self.size
                text: root.text_label + ":"
                halign: 'center'
                valign: 'center'
                size_hint: 0.8,0.5
        TextInput:
                id: text_input
                input_filter: root.input_type
                size_hint: 0.2,0.5
                hint_text: str(root.value)
                halign: 'left'
                multiline:False
                

<MySlider>:
        id: myslider
        orientation: "horizontal"
        halign: 'left'
        valign: 'left'
        Label:
                text: root.slider_label + ":"
        TextInput:
                id: textinput
                multiline: False
                input_filter: 'int'
                text: str(slider.value)
                on_text_validate:
                        if int(self.text)%2 == 0: slider.value = int(self.text)+1
                        else: slider.value = int(self.text)
                        root.slider_change(slider.value)
                        #MODIFICAR
                size_hint: 0.2,0.1
                halign: 'left'
                valign: 'left'

        BoxLayout:
                orientation: "vertical"
                spacing: 10
                Slider:
                        id: slider
                        value_track: True
                        value_track_color: [1, 0, 0, 1]
                        min: root.minimum
                        max: root.maximum
                        step: root.step
                        value: root.value
                        #on_value: root.value = self.value #es lo mismo que hacer el slider_change
                        on_touch_move: root.slider_change(slider.value)
                        on_touch_down: root.slider_change(slider.value)
                        on_touch_up: root.slider_change(slider.value)
                        size_hint: 1,1   
                
                Label:
                        id: label
                        text: str(slider.value)
                BoxLayout:
                        orientation: "horizontal"

<MyImageSpinner>:

        Image:
                id:imageplan
                source: root.options.get(spinner.text)
                size_hint:1,1
        Spinner:
                id: spinner
                text: root.text
                values: root.options.keys()
                size_hint: 1, 1
                font_size: '12sp'

<MySpinner>:
        id: myspinner
        orientation: "vertical"
        Label:
                text: root.spinner_label + ":"
                size_hint: 0.4,1
        Label:
                text: ""
                size_hint: 0.6,1  
        TextInput:
                id: textinput
                multiline: False
                text: (spinner.text)
                on_text_validate: root.get_code(self.text)
                size_hint: 0.4,1
                font_size: '12sp'
        
        Spinner:
                id: spinner
                text: root.text
                values: root.values
                size_hint: 0.6,1   
                font_size: '12sp'

<MyBubble>:
        size_hint: (None, None)
        size: (100, 75)
        #pos_hint: {'x': 1, 'y': 1}
        BubbleButton:
                text: 'Eliminar'
                on_touch_down: print('touch')

<LoadDialog>:
        cols: 2
        id: load
        BoxLayout:
                size: root.size
                pos: root.pos
                orientation: "vertical"
                size_hint: 0.7,1

                Label:
                        text: "Choose path:"
                        size_hint_y: None
                        height: 20
                        halign: 'right'

                BoxLayout:
                        size_hint: 1,.1
                        TextInput:
                                id: path_input
                                size_hint_x: 0.7
                                size_hint_y: None
                                height: 30
                                multiline: False
                                text: "C:/Users/trini/Pictures"
                                #text:"C:/Users/Juliana/Downloads"
                                #El text esta puesto por comodidad para nosotras. 
                                #En un futuro deberiamos eliminarlo o dejar como ejemplo en hint_text
                                on_text_validate: load.new_path(path_input.text)
                                
                        Button:
                                text: "OK"
                                size_hint_x: 0.2
                                size_hint_y: None
                                height: 30
                                halign: 'right'
                                on_press: load.new_path(path_input.text)

                FileChooserIconView:
                        id: filechooser
                        filters: ['*.jpg', '*.png']
                        on_selection: load.selected(filechooser.selection)
                               

                BoxLayout:
                        size_hint: 1,.1
                        
                        Button:
                                text: "Cancel"
                                on_release: root.cancel()
                        Button:
                                text: "Load"
                                on_release: root.load(filechooser.path, filechooser.selection)
        
        Image:
                id: load_image
                size_hint: 0.5,1
                color: 0,0,0,0

<Popup_Extraer_Codigo>:
        Label:
                text: "Su codigo se ha exportado exitosamente"
                size_hint: None, None
                pos_hint: {"x":0.35, "top":1}

<Popup_Delete_Line>:
        BoxLayout:
                orientation:"vertical"
                #pos_hint: {"x":0.35, "top":1}
                pos_hint: {"x": 0, "top": 1}
                Label:
                        text: "Desea eliminar esta union?"
                        #size_hint: None, None
                        size_hint: 1, .3
                        valign: 'middle'
                        halign: 'center'
                BoxLayout:
                        orientation:"horizontal"
                        pos_hint: {'x':0}
                        size_hint: 1, .3
                        Button:
                                text: "Si"
                                size_hint: .5, 1
                                on_press: root.mainfloat.delete_line(root.line)
                        Button:
                                text: "Cancelar"
                                size_hint: .5, 1
                                on_press: root.mainfloat.delete_line_popup.dismiss()
<Save_workspace_button>:
        BoxLayout:
                orientation: 'vertical'
                TextInput:
                        id: filename_input
                        multiline: False
                        text: "saved_file"
                        on_text_validate: root.mainfloat.to_file(filename_input.text)
                                
                        
                BoxLayout:
                        orientation: 'horizontal'
                        Button:
                                text: "Cancel"
                                size_hint: .3,.9
                                on_press: root.mainfloat.dismiss_extraer_popup()
                        Button:
                                text: "Save"
                                size_hint: .3,.9
                                on_press: root.mainfloat.to_file(filename_input.text)
                        
<ImageViewer>:
        do_default_tab: False
        tab_width: None


<MyWidget>:          
        BoxLayout:
                orientation: 'horizontal'
                Image:
                        id: view_image
                        source: ""
                        color: 0,1,0,1  
                        size_hint: .9,1
                BoxLayout:
                        orientation: 'horizontal'
                        
                        Label:
                                pos_hint: {"top": 1}
                                text: root.text
                                markup: True
                                size_hint: .2,.1
                        BoxLayout:
                                pos_hint: {"top": 1}
                                id: histogram
                                size_hint: .8,.4

<MyCheckBox>:
        width: self.parent.width if self.parent else 0
        height: dp(26)
        font_size: '15sp'
        BoxLayout:
                orientation: 'horizontal'
                Label:
                        text: ""
                Label:
                        text: root.parameter_text
                        padding: dp(10), 0
                        valign: 'middle'
                        halign: 'left'
                        size_hint: None, 1
                        font_size: '16'
                
                CheckBox:
                        active: root.active
                        halign: 'right'
                        on_active: root.on_checkbox_active(self.active)

<MyIconButton>:
        on_press: self.background_color = (0, 1, 1, 1)
        on_release: self.background_color = (0, 0, 0, 1)
        Image:
                source:"icons\image_icon1.png"
                center_x: self.parent.center_x
                center_y: self.parent.center_y
                size: 25,25
                #allow_stretch: True

<MyParameterButton>:
        on_press: self.background_color = (0, 1, 1, 1)
        on_release: self.background_color = (0, 0, 0, 1)
        Image:
                id: param_imag
                source: ""
                center_x: self.parent.center_x
                center_y: self.parent.center_y
                size: 25,25
                #allow_stretch: True
        
<MyLabel>:
        background_color: 0.2, 0.2, 0.2, 1.0
        canvas.before:
                Color:
                        rgba: self.background_color
                Rectangle:
                        size: self.size
                        pos: self.pos
        #text properties
        color: 0.7, 0.7, 0.7, 1.0
        #outline_color: 0,0,0
        #outline_width: 1

<DDButton@Button>:
        size_hint_y: None
        height: '50dp'
        # Double .parent because dropdown proxies add_widget to container
        on_release: self.parent.parent.select(self.text)